-- DESCARGA
-- Solo en dispositivos de alta gama
CREATE DEFINER=`root`@`localhost` TRIGGER `descarga_BEFORE_INSERT` BEFORE INSERT ON `descarga` FOR EACH ROW BEGIN
DECLARE TotalMins INT UNSIGNED;
DECLARE titulito VARCHAR(40);
DECLARE fechita DATE;
DECLARE VTO DATE;
DECLARE califi VARCHAR(10);
DECLARE gamita VARCHAR(10);

-- CHEQUEO SI ES ALTA GAMA
SELECT ModeloDisp INTO gamita
FROM descarga INNER JOIN dispositivo ON descarga.idDispositivo = dispositivo.idDispositivo
WHERE descarga.idDispositivo = NEW.descarga.idDispositivo;

-- NO HAY ESPACIO PARA LA DESCARGA --
SELECT SUM(contenido.Duracion) INTO TotalMins
FROM descarga 
INNER JOIN contenido ON descarga.TiOriginal = contenido.TiOriginal
WHERE descarga.Username = NEW.Username;

-- YA LO DESCARGÓ --
SELECT TiOriginal INTO titulito
FROM descarga
WHERE (Username = NEW.Username AND TiOriginal = NEW.TiOriginal);

-- ABONO VENCIDO --
SELECT FechaVTO INTO VTO
FROM descarga 
INNER JOIN usuario ON descarga.Username = usuario.Username
INNER JOIN abono ON usuario.Email = abono.Email
WHERE usuario.Username = NEW.usuario.Username
GROUP BY Email;

-- NIÑOS --
SELECT FechaNac INTO fechita
FROM descarga INNER JOIN usuario ON descarga.Username = usuario.Username
WHERE Username = NEW.Username;
	
SELECT CalifSalida INTO califi
FROM 
(
-- Pelicula
(SELECT TiOriginal FROM descarga 
INNER JOIN pelicula ON descarga.TiOriginal = pelicula.TiOriginal) 
    
UNION
    
-- Documental
(SELECT TiOriginal FROM descarga 
INNER JOIN documental ON descarga.TiOriginal = documental.TiOriginal)
    
UNION
    
-- Serie
(SELECT NombreSerie AS TiOriginal FROM descarga 
INNER JOIN capitulo ON capitulo.TiOriginal = descarga.TiOriginal
INNER JOIN serie ON serie.NombreSerie = capitulo.NombreSerie) 
) as e
WHERE(TiOriginal = NEW.TiOriginal);

-- Si ya lo descargó
IF titulito IS NOT NULL THEN
	SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'el contenido ya ha sido descargado por el usuario';
ELSE
	-- Si no hay espacio
	IF TotalMins + (SELECT Duracion FROM contenido WHERE TiOriginal = NEW.TiOriginal) > 240 THEN
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'NO HAY ESPACIO. La descarga supera el límite de 4 horas de contenido.';
    ELSE
		-- Si no pagó
		IF CURDATE() >= VTO + 5 THEN
			SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Abono pendiente de pago.';
		ELSE 
			-- Si es niño
			IF YEAR(CURDATE()) - YEAR(fechita) < 13 AND califi NOT LIKE 'ATP' THEN
				SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Restricción de menor de edad aplicada sobre este título';
			ELSE
				-- no es de alta gama
				IF gamita NOT LIKE 'alta gama' THEN
					SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El dispositivo donde se quiso descargar no es de alta gama';
                ELSE
					-- Si el dispositivo no le pertenece a la persona
                    IF NEW.descarga.idDispositivo NOT IN (SELECT idDispositivo FROM dispositivo WHERE dispositivo.Username = NEW.descarga.Username) THEN
						SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El dispositivo no le pertenece al usuario';
                    END IF;
                END IF;
			END IF;
		END IF;
	END IF;
END IF;

END$$
